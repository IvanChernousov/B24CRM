<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="//api.bitrix24.com/api/v1/"></script>
</head>
<body>
 

<script>
BX24.init(function() {
    console.log('IBAN Validator loaded');

    // Функция валидации IBAN
    function validateIBANLocal(iban) {
        if (!iban) return true; // Пустое поле - пропускаем
        
        iban = iban.replace(/\s+/g, '').toUpperCase();

        if (!/^[A-Z0-9]+$/.test(iban)) return false;
        if (iban.length < 15 || iban.length > 34) return false;

        // Перемещаем первые 4 символа в конец
        iban = iban.slice(4) + iban.slice(0, 4);

        // Заменяем буквы на цифры
        iban = iban.replace(/[A-Z]/g, function(char) {
            return char.charCodeAt(0) - 55;
        });

        // Вычисляем остаток по модулю 97
        let remainder = iban;
        while (remainder.length > 2) {
            let block = remainder.slice(0, 9);
            remainder = (parseInt(block, 10) % 97) + remainder.slice(block.length);
        }

        return parseInt(remainder, 10) % 97 === 1;
    }

    // Подписываемся на событие сохранения
    BX24.placement.bindEvent('onCrmEntityUpdate', function(data) {
        console.log('Contact update event:', data);
        
        // Получаем текущие данные контакта
        BX24.callMethod('crm.contact.get', {
            id: data.ENTITY_ID
        }, function(result) {
            if (result.error()) {
                console.error('Error getting contact:', result.error());
                return;
            }
            
            let contact = result.data();
            let iban = contact.UF_CRM_IBAN || contact.UF_CRM_1734013382;
            
            console.log('IBAN value:', iban);
            
            if (iban && !validateIBANLocal(iban)) {
                alert('❌ Invalid IBAN format!\n\nPlease check the IBAN number.');
                
                // Можно добавить комментарий к контакту
                BX24.callMethod('crm.timeline.comment.add', {
                    fields: {
                        ENTITY_ID: data.ENTITY_ID,
                        ENTITY_TYPE: 'contact',
                        COMMENT: 'Warning: Invalid IBAN format detected!'
                    }
                });
            }
        });
    });

    console.log('IBAN Validator initialized successfully');
});
</script>

</body>
</html>

