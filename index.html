<!DOCTYPE html>
<html>
<head>
    <script src="https://api.bitrix24.com/api/v1/"></script>
</head>
<body>

<script>
BX24.init(function() {

    function validateIBANLocal(iban) {
        iban = iban.replace(/\s+/g, '').toUpperCase();

        if (!/^[A-Z0-9]+$/.test(iban)) return false;

        iban = iban.slice(4) + iban.slice(0,4);

        iban = iban.replace(/[A-Z]/g, function(char) {
            return char.charCodeAt(0) - 55;
        });

        let remainder = iban;
        while (remainder.length > 2) {
            let block = remainder.slice(0, 9);
            remainder = (parseInt(block, 10) % 97) + remainder.slice(block.length);
        }

        return parseInt(remainder, 10) % 97 === 1;
    }

    BX.addCustomEvent('BX.Crm.EntityEditor:onSave', function(event) {

        let editor = event.getData()[0];
        let ibanField = editor.getControlById('UF_CRM_IBAN');

        if (!ibanField) return;

        let iban = ibanField.getValue();
        if (!iban) return;

        if (!validateIBANLocal(iban)) {
            alert("Invalid IBAN format");
            event.preventDefault();
        }

    });

});
</script>

</body>
</html>
