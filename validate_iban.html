<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="//api.bitrix24.com/api/v1/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-size: 16px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        h2 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h2>üîç –í–∞–ª–∏–¥–∞—Ü–∏—è IBAN</h2>
    <div id="status" class="result loading">–ü—Ä–æ–≤–µ—Ä—è–µ–º IBAN...</div>

<script>
BX24.init(function() {
    
    // –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ IBAN
    function validateIBAN(iban) {
        if (!iban) return false;
        
        iban = iban.replace(/\s+/g, '').toUpperCase();
        
        if (!/^[A-Z0-9]+$/.test(iban)) return false;
        if (iban.length < 15 || iban.length > 34) return false;
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ø–µ—Ä–≤—ã–µ 4 —Å–∏–º–≤–æ–ª–∞ –≤ –∫–æ–Ω–µ—Ü
        iban = iban.slice(4) + iban.slice(0, 4);
        
        // –ó–∞–º–µ–Ω—è–µ–º –±—É–∫–≤—ã –Ω–∞ —Ü–∏—Ñ—Ä—ã
        iban = iban.replace(/[A-Z]/g, function(char) {
            return char.charCodeAt(0) - 55;
        });
        
        // –í—ã—á–∏—Å–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ –º–æ–¥—É–ª—é 97
        let remainder = iban;
        while (remainder.length > 2) {
            let block = remainder.slice(0, 9);
            remainder = (parseInt(block, 10) % 97) + remainder.slice(block.length);
        }
        
        return parseInt(remainder, 10) % 97 === 1;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
    var placement = BX24.placement.info();
    var contactId = placement.options.ID;
    
    console.log('Contact ID:', contactId);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
    BX24.callMethod('crm.contact.get', {
        id: contactId
    }, function(result) {
        if (result.error()) {
            showError('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ' + result.error());
            console.error(result.error());
            return;
        }
        
        var contact = result.data();
        console.log('Contact data:', contact);
        
        // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ–ª–µ IBAN (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–µ –ø–æ–ª–µ)
        var iban = contact.UF_CRM_IBAN || contact.UF_CRM_1734013382;
        
        if (!iban) {
            showError('‚ùå –ü–æ–ª–µ IBAN –ø—É—Å—Ç–æ–µ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        
        console.log('IBAN value:', iban);
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        var isValid = validateIBAN(iban);
        
        console.log('IBAN is valid:', isValid);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–µ –ø–æ–ª–µ —Å—Ç–∞—Ç—É—Å–∞)
        var statusField = 'UF_CRM_IBAN_STATUS';
        var updateFields = {};
        updateFields[statusField] = isValid ? 'Valid' : 'Invalid';
        
        BX24.callMethod('crm.contact.update', {
            id: contactId,
            fields: updateFields
        }, function(updateResult) {
            if (updateResult.error()) {
                console.error('Update error:', updateResult.error());
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å
                if (isValid) {
                    showSuccess('‚úÖ IBAN –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: ' + iban + '<br><small>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</small>');
                } else {
                    showError('‚ùå IBAN –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: ' + iban + '<br><small>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</small>');
                }
            } else {
                console.log('Update success');
                
                if (isValid) {
                    showSuccess('‚úÖ IBAN –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: ' + iban + '<br><small>–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω</small>');
                } else {
                    showError('‚ùå IBAN –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: ' + iban + '<br><small>–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω</small>');
                }
            }
        });
    });
    
    function showSuccess(message) {
        var el = document.getElementById('status');
        el.className = 'result success';
        el.innerHTML = message;
        
        // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(function() {
            BX24.closeApplication();
        }, 3000);
    }
    
    function showError(message) {
        var el = document.getElementById('status');
        el.className = 'result error';
        el.innerHTML = message;
    }
});
</script>

</body>
</html>
